#!/usr/bin/env ../bin/opsh

lib::import ssh

[[ $# -eq 1 ]] || log::fatal "usage: $0 <statedir>"

STATEDIR=$1
shift

umask 077

mkdir -p "$STATEDIR"

log::info "storing SPE state inside '$STATEDIR'..."
cd "$STATEDIR" || log::fatal "couldn't enter state directory '$STATEDIR'!"

SPEINFO=speInfo

log::info "dumping SPE info..."
pulumi stack output --show-secrets speInfo >"$SPEINFO"

get() {
    jq --exit-status -r "$@" <"$SPEINFO" || log::fatal "failed to get info for key $*"
}

ssh::begin

ssh::config <<EOF
Host *
     UserKnownHostsFile /dev/null
     StrictHostKeyChecking off
EOF

log::info "loading up authentication information..."

log::info "adding key for bootstrap node..."
get .bootstrap.connection.private_key | ssh::key::add

NODECOUNT=$(get '.otherValidators | length')
NODEINDICES=$(seq 0 "$(( NODECOUNT - 1))")

log::info "found $NODECOUNT non-bootstrap nodes..."

ssh::background::run -L 8899:localhost:8899 "$(get .bootstrap.connection.user)@$(get .bootstrap.connection.host)"

SOLANA="solana -u http://localhost:8899"

log::info "getting validator state..."
$SOLANA validators

log::info "extracting treasury key..."
get ".treasuryKey.json" >treasuryKey.json

for i in $NODEINDICES; do
    NODENAME="node$i"
    DIR="$NODENAME"
    mkdir -p "$DIR"

    if [[ ! -e "$NODENAME/stake-setup" ]]; then
        log::info "staking and delegating to $NODENAME..."
        get ".otherValidators[$i].voteAccountKey.json" >"$DIR/voteAccountKey.json"

        solana-keygen new --no-passphrase -o "$NODENAME/stakeKey.json"
        $SOLANA -k treasuryKey.json create-stake-account "$NODENAME/stakeKey.json" 150
        $SOLANA -k treasuryKey.json delegate-stake "$NODENAME/stakeKey.json" "$NODENAME/voteAccountKey.json"
        touch "$DIR/stake-setup"
    else
        log::info "skipping stake account setup and initial funding of $NODENAME..."
    fi
done

log::info "checking validator stake warm-up for 60 seconds, printing every 15 seconds..."
for i in {1..4}; do
    $SOLANA validators
    sleep 15
    log::info "elapsed $((i * 15)) seconds... (press Ctrl+C to exit)"
done
